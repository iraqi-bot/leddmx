<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEDDMX-03 Debugger</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; text-align: center; }
        .card { border: 1px solid #0f0; padding: 20px; display: inline-block; max-width: 400px; width: 100%; }
        button { background: #000; color: #0f0; border: 1px solid #0f0; padding: 10px; margin: 5px; width: 90%; cursor: pointer; font-weight: bold; }
        button:hover { background: #0f0; color: #000; }
        #log { text-align: left; background: #111; padding: 10px; height: 150px; overflow-y: scroll; border: 1px solid #333; margin-top: 10px; font-size: 11px; }
        .on { border-color: #0f0; color: #0f0; }
        .off { border-color: #f00; color: #f00; }
    </style>
</head>
<body>

<div class="card">
    <h3>[ LEDDMX-03 PROTOCOL SCANNER ]</h3>
    
    <button onclick="connect()">1. CONNECT & SCAN</button>
    <hr>
    
    <p>2. TEST INITIALIZATION (Watch for Flicker)</p>
    <button onclick="testInit(1)">TRY SYNC 1 (7E-00-09)</button>
    <button onclick="testInit(2)">TRY SYNC 2 (7E-04-09)</button>
    <button onclick="testInit(3)">TRY SYNC 3 (7E-05-09)</button>
    
    <hr>
    <p>3. TEST POWER</p>
    <button class="on" onclick="power(true)">POWER ON</button>
    <button class="off" onclick="power(false)">POWER OFF</button>
    
    <p>4. COLOR PICKER</p>
    <input type="color" id="picker" style="width:100%; height:50px;" oninput="sendColor(this.value)">

    <div id="log">Console Ready...</div>
</div>

<script>
    let char = null;
    let selectedMode = 1;

    function log(m) {
        const l = document.getElementById('log');
        l.innerHTML += `> ${m}<br>`;
        l.scrollTop = l.scrollHeight;
    }

    async function connect() {
        try {
            log("Searching...");
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: [0xffe0, 0xfff0, 0xffd0]
            });
            log("Connecting to " + device.name);
            const server = await device.gatt.connect();
            
            // Search for the write characteristic
            const services = await server.getPrimaryServices();
            for (let s of services) {
                log("Found Service: " + s.uuid.substring(4,8));
                let chars = await s.getCharacteristics();
                for (let c of chars) {
                    if (c.properties.writeWithoutResponse || c.properties.write) {
                        char = c;
                        log("Target Found: " + c.uuid.substring(4,8));
                        break;
                    }
                }
                if (char) break;
            }
            log("READY.");
        } catch (e) { log("ERR: " + e.message); }
    }

    async function raw(bytes) {
        if (!char) return log("Not connected!");
        try {
            // Some Symphony chips CRASH on 'WriteWithResponse'
            // We try WithoutResponse first
            await char.writeValueWithoutResponse(new Uint8Array(bytes));
        } catch (e) {
            await char.writeValue(new Uint8Array(bytes));
        }
    }

    function testInit(mode) {
        selectedMode = mode;
        log(`Testing Mode ${mode}...`);
        let head = (mode === 1) ? 0x00 : (mode === 2 ? 0x04 : 0x05);
        
        // Command: Set 200 Pixels (00 C8)
        raw([0x7e, head, 0x09, 0x00, 0xc8, 0x00, 0x00, 0x00, 0xef]);
        
        // Command: Set GRB Sort
        setTimeout(() => raw([0x7e, head, 0x08, 0x02, 0x00, 0x00, 0x00, 0x00, 0xef]), 200);
        
        // Command: Force Static Mode
        setTimeout(() => raw([0x7e, head, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0xef]), 400);
    }

    function power(on) {
        let head = (selectedMode === 1) ? 0x00 : (selectedMode === 2 ? 0x04 : 0x05);
        let val = on ? 0x01 : 0x00;
        raw([0x7e, head, 0x04, val, 0x00, 0x00, 0x00, 0x00, 0xef]);
    }

    function sendColor(hex) {
        let r = parseInt(hex.substring(1,3), 16);
        let g = parseInt(hex.substring(3,5), 16);
        let b = parseInt(hex.substring(5,7), 16);
        let head = (selectedMode === 1) ? 0x00 : (selectedMode === 2 ? 0x04 : 0x05);
        
        // Some Symphony chips require: 7E [Head] 05 03 R G B 00 EF
        raw([0x7e, head, 0x05, 0x03, r, g, b, 0x00, 0xef]);
    }
</script>
</body>
</html>
