<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED LAMP Protocol Sniper</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #000; color: #0f0; text-align: center; padding: 20px; }
        .card { border: 2px solid #0f0; padding: 20px; border-radius: 10px; display: inline-block; width: 350px; }
        button { background: #000; color: #0f0; border: 1px solid #0f0; padding: 15px; margin: 5px; width: 100%; cursor: pointer; font-weight: bold; }
        button:hover { background: #0f0; color: #000; }
        #log { text-align: left; font-size: 11px; height: 180px; overflow-y: auto; border: 1px solid #030; margin-top: 20px; padding: 10px; color: #0a0; }
        .btn-group { display: flex; justify-content: space-between; }
        .btn-group button { width: 48%; }
        input[type="color"] { width: 100%; height: 80px; background: #222; border: 1px solid #0f0; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="card">
        <h2>SNIPER: PHY6256</h2>
        
        <button onclick="nuclearConnect()">1. NUCLEAR CONNECT</button>
        <button style="color: #f00; border-color: #f00;" onclick="sendBurst()">2. SEND BURST SYNC</button>

        <div class="btn-group">
            <button onclick="power(true)">POWER ON</button>
            <button onclick="power(false)">POWER OFF</button>
        </div>
        
        <input type="color" id="picker" value="#ff0000" oninput="changeColor(this.value)">

        <div id="log">READY SYSTEM...</div>
    </div>

    <script>
        let targets = [];

        function log(m) {
            const l = document.getElementById('log');
            l.innerHTML += `> ${m}<br>`;
            l.scrollTop = l.scrollHeight;
        }

        async function nuclearConnect() {
            try {
                log("Scanning all services...");
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [0xffe0, 0xfff0, 0xae00, 0xfee0, 0xffd0]
                });

                log("Connecting to GATT...");
                const server = await device.gatt.connect();
                const services = await server.getPrimaryServices();
                
                targets = [];
                for (let s of services) {
                    log(`Svc: ${s.uuid.substring(4,8)}`);
                    let chars = await s.getCharacteristics();
                    for (let c of chars) {
                        if (c.properties.write || c.properties.writeWithoutResponse) {
                            targets.push(c);
                            log(` Found WrChar: ${c.uuid.substring(4,8)}`);
                        }
                    }
                }
                log(`LOCKED ON ${targets.length} CHANNELS.`);
            } catch (e) { log("CRITICAL ERR: " + e.message); }
        }

        async function multiSend(packet) {
            if (targets.length === 0) return log("No targets locked!");
            const data = new Uint8Array(packet);
            for (let t of targets) {
                try {
                    // PHY6256 chips often flip-flop between needing Response or Not
                    await t.writeValueWithoutResponse(data);
                } catch (e) {
                    try { await t.writeValue(data); } catch (err) {}
                }
            }
        }

        async function sendBurst() {
            log("Firing Protocol Burst...");
            // Sequence used by PHY6256 Symphony controllers
            // Packet A: Set Pixels 200 (7E 00 09)
            await multiSend([0x7e, 0x00, 0x09, 0x00, 0xc8, 0x00, 0x00, 0x00, 0xef]);
            
            // Packet B: RGB Sort GRB (7E 00 08)
            setTimeout(() => multiSend([0x7e, 0x00, 0x08, 0x02, 0x00, 0x00, 0x00, 0x00, 0xef]), 150);
            
            // Packet C: Static Mode Force (7E 00 03)
            setTimeout(() => multiSend([0x7e, 0x00, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0xef]), 300);
            
            // Packet D: Brightness 100% (7E 00 01 64)
            setTimeout(() => multiSend([0x7e, 0x00, 0x01, 0x64, 0x00, 0x00, 0x00, 0x00, 0xef]), 450);
            
            log("BURST COMPLETE. Check for light.");
        }

        function power(on) {
            const v = on ? 0x01 : 0x00;
            // Trying both 00 and 04 headers
            multiSend([0x7e, 0x00, 0x04, v, 0x00, 0x00, 0x00, 0x00, 0xef]);
            setTimeout(() => multiSend([0x7e, 0x04, 0x04, v, 0x00, 0x00, 0x00, 0x00, 0xef]), 100);
        }

        function changeColor(hex) {
            const r = parseInt(hex.substring(1,3), 16);
            const g = parseInt(hex.substring(3,5), 16);
            const b = parseInt(hex.substring(5,7), 16);
            // Color sequence: 7E 00 05 03 R G B 00 EF
            multiSend([0x7e, 0x00, 0x05, 0x03, r, g, b, 0x00, 0xef]);
        }
    </script>
</body>
</html>
