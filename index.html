<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LED Control</title>
    <style>
        :root { --bg: #0f111a; --card: #1c1f2b; --accent: #00d2ff; --green: #00ff88; --red: #ff4d4d; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .app { width: 90%; max-width: 400px; background: var(--card); padding: 25px; border-radius: 30px; text-align: center; }
        .btn { width: 100%; padding: 16px; border-radius: 15px; border: none; font-size: 16px; font-weight: bold; margin-bottom: 12px; display: block; }
        .connect { background: var(--accent); color: #000; }
        .sync { background: #f39c12; color: #000; }
        .power-grid { display: flex; gap: 10px; margin-bottom: 20px; }
        .on { background: var(--green); flex: 1; }
        .off { background: var(--red); flex: 1; }
        input[type="color"] { width: 100%; height: 120px; border-radius: 20px; border: none; background: none; }
        
        /* Error message style */
        #browser-warning { 
            background: var(--red); color: white; padding: 15px; border-radius: 10px; 
            margin-bottom: 15px; display: none; font-size: 12px; line-height: 1.4;
        }
        #log { font-family: monospace; font-size: 10px; color: #888; margin-top: 10px; }
    </style>
</head>
<body>

<div class="app">
    <h2>LED CONTROL</h2>

    <!-- This shows only if Bluetooth is missing -->
    <div id="browser-warning">
        ⚠️ <b>Browser Not Supported</b><br>
        If on iPhone: Use the <b>Bluefy</b> app.<br>
        If on Android: Use <b>Chrome</b> and check HTTPS.
    </div>
    
    <button class="btn connect" id="connBtn" onclick="connect()">CONNECT BLUETOOTH</button>
    <button class="btn sync" onclick="syncPixels()">ACTIVATE SYMPHONY</button>

    <div class="power-grid">
        <button class="btn on" onclick="power(1)">ON</button>
        <button class="btn off" onclick="power(0)">OFF</button>
    </div>

    <input type="color" id="color" value="#00ff00" oninput="throttledColor(this.value)">

    <div id="log">System Ready</div>
</div>

<script>
    // CHECK FOR BLUETOOTH SUPPORT ON LOAD
    window.onload = function() {
        if (!navigator.bluetooth) {
            document.getElementById('browser-warning').style.display = 'block';
            document.getElementById('connBtn').disabled = true;
            document.getElementById('connBtn').style.opacity = '0.5';
        }
    };

    let ledChar = null;
    let isSending = false;

    async function connect() {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'led' }, { namePrefix: 'LED' }],
                optionalServices: [0xffe0]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(0xffe0);
            ledChar = await service.getCharacteristic(0xffe1);
            document.getElementById('log').innerHTML = "Connected to " + device.name;
        } catch (e) {
            alert("Connection Error: " + e.message);
        }
    }

    async function send(data) {
        if (!ledChar) return;
        try {
            await ledChar.writeValueWithoutResponse(new Uint8Array(data));
        } catch (e) { console.error(e); }
    }

    async function syncPixels() {
        // Set 200 pixels
        await send([0x7e, 0x00, 0x09, 0x00, 0xc8, 0x00, 0x00, 0x00, 0xef]);
        setTimeout(() => send([0x7e, 0x00, 0x08, 0x02, 0x00, 0x00, 0x00, 0x00, 0xef]), 200); // Sort
        setTimeout(() => send([0x7e, 0x00, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0xef]), 400); // Static mode
    }

    function power(s) {
        send([0x7e, 0x00, 0x04, s, 0x00, 0x00, 0x00, 0x00, 0xef]);
    }

    function throttledColor(hex) {
        if (isSending) return;
        isSending = true;
        const r = parseInt(hex.substring(1, 3), 16);
        const g = parseInt(hex.substring(3, 5), 16);
        const b = parseInt(hex.substring(5, 7), 16);
        send([0x7e, 0x00, 0x05, 0x03, r, g, b, 0x00, 0xef]);
        setTimeout(() => { isSending = false; }, 60);
    }
</script>
</body>
</html>
