<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symphony Sweeper (PHY6256)</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; text-align: center; padding: 20px; }
        .card { border: 2px solid #0f0; padding: 20px; display: inline-block; width: 350px; }
        button { background: #000; color: #0f0; border: 1px solid #0f0; padding: 12px; margin: 5px; width: 100%; cursor: pointer; font-weight: bold; }
        .scan-btn { background: #0f0; color: #000; }
        #log { text-align: left; font-size: 11px; height: 200px; overflow-y: auto; border: 1px solid #030; margin-top: 20px; padding: 10px; }
        .status-box { border: 1px solid #0f0; margin: 10px 0; padding: 10px; font-size: 18px; color: #fff; }
    </style>
</head>
<body>

    <div class="card">
        <h2>PHY6256 SWEEPER</h2>
        
        <button onclick="connect()">1. CONNECT (ffe1)</button>
        
        <div class="status-box" id="activeHeader">HEADER: --</div>

        <p style="font-size: 10px;">2. CLICK START TO SCAN PROTOCOLS</p>
        <button class="scan-btn" id="scanBtn" onclick="toggleScan()">START AUTO-SCAN</button>

        <p style="font-size: 10px;">3. IF IT FLICKERS, STOP SCAN & TRY POWER</p>
        <button onclick="power(true)">FORCE POWER ON</button>
        <button onclick="power(false)">FORCE POWER OFF</button>

        <div id="log">SYSTEM READY...</div>
    </div>

    <script>
        let char = null;
        let scanInterval = null;
        let currentHeader = 0;

        function log(m) {
            const l = document.getElementById('log');
            l.innerHTML += `> ${m}<br>`;
            l.scrollTop = l.scrollHeight;
        }

        async function connect() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'leddmx' }, { namePrefix: 'LED' }],
                    optionalServices: [0xffe0]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(0xffe0);
                char = await service.getCharacteristic(0xffe1);
                log("LOCKED ON ffe1");
            } catch (e) { log("ERR: " + e.message); }
        }

        async function send(data) {
            if (!char) return;
            try {
                await char.writeValueWithoutResponse(new Uint8Array(data));
            } catch (e) { }
        }

        function toggleScan() {
            const btn = document.getElementById('scanBtn');
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
                btn.innerText = "START AUTO-SCAN";
                log("SCAN STOPPED AT " + currentHeader);
            } else {
                log("SWEEPING HEADERS 0-7...");
                btn.innerText = "STOP SCAN (IF FLICKER)";
                scanInterval = setInterval(sweep, 500);
            }
        }

        async function sweep() {
            document.getElementById('activeHeader').innerText = "HEADER: 0x0" + currentHeader;
            
            // We send a 3-part sequence for every header:
            // 1. Set Pixels (200)
            await send([0x7e, currentHeader, 0x09, 0x00, 0xc8, 0x00, 0x00, 0x00, 0xef]);
            
            // 2. Set Red Color
            setTimeout(() => send([0x7e, currentHeader, 0x05, 0x03, 0xff, 0x00, 0x00, 0x00, 0xef]), 100);
            
            // 3. Force On
            setTimeout(() => send([0x7e, currentHeader, 0x04, 0x01, 0x00, 0x00, 0x00, 0x00, 0xef]), 200);

            currentHeader++;
            if (currentHeader > 7) currentHeader = 0;
        }

        function power(on) {
            const h = currentHeader === 0 ? 0 : currentHeader - 1; // Use last scanned header
            const val = on ? 0x01 : 0x00;
            log(`Sending Power ${on} with Header ${h}`);
            send([0x7e, h, 0x04, val, 0x00, 0x00, 0x00, 0x00, 0xef]);
        }
    </script>
</body>
</html>
