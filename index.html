<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LED Controller</title>
    <style>
        :root { --bg: #0f111a; --card: #1c1f2b; --accent: #00d2ff; --green: #00ff88; --red: #ff4d4d; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; background: var(--bg); color: white; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        .app { width: 90%; max-width: 400px; background: var(--card); padding: 25px; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; }
        h2 { margin: 0 0 20px; font-weight: 300; letter-spacing: 2px; color: var(--accent); }
        
        .btn { width: 100%; padding: 16px; border-radius: 15px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-bottom: 12px; display: block; -webkit-tap-highlight-color: transparent; }
        .connect { background: var(--accent); color: #000; }
        .sync { background: #f39c12; color: #000; }
        .power-grid { display: flex; gap: 10px; margin-bottom: 20px; }
        .on { background: var(--green); color: #000; flex: 1; }
        .off { background: var(--red); color: white; flex: 1; }
        .btn:active { transform: scale(0.96); opacity: 0.8; }

        .picker-container { position: relative; margin: 20px 0; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 100%; height: 150px; border-radius: 20px; background: none; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 20px; box-shadow: inset 0 0 20px rgba(0,0,0,0.3); }

        #log { font-family: monospace; font-size: 10px; color: #555; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; text-align: left; height: 60px; overflow-y: auto; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; background: #333; margin-right: 5px; }
        .online { background: var(--green); box-shadow: 0 0 10px var(--green); }
    </style>
</head>
<body>

<div class="app">
    <h2>LED CONTROL</h2>
    
    <button class="btn connect" id="connBtn" onclick="connect()">CONNECT BLUETOOTH</button>
    <button class="btn sync" onclick="syncPixels()">ACTIVATE (SET PIX 200)</button>

    <div class="power-grid">
        <button class="btn on" onclick="power(1)">ON</button>
        <button class="btn off" onclick="power(0)">OFF</button>
    </div>

    <div class="picker-container">
        <input type="color" id="color" value="#00ff00" oninput="throttledColor(this.value)">
    </div>

    <div id="log"><span class="status-dot" id="dot"></span>Ready</div>
</div>

<script>
    let ledChar = null;
    let isSending = false;

    function log(m) {
        document.getElementById('log').innerHTML = m;
        if (navigator.vibrate) navigator.vibrate(10);
    }

    async function connect() {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'leddmx' }, { namePrefix: 'LED' }],
                optionalServices: [0xffe0]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(0xffe0);
            ledChar = await service.getCharacteristic(0xffe1);
            
            document.getElementById('dot').classList.add('online');
            document.getElementById('connBtn').innerText = "DEVICE CONNECTED";
            log("Connected: " + device.name);
        } catch (e) {
            log("Error: " + e.message);
        }
    }

    async function send(data) {
        if (!ledChar) return;
        try {
            await ledChar.writeValueWithoutResponse(new Uint8Array(data));
        } catch (e) { console.log(e); }
    }

    async function syncPixels() {
        log("Setting 200 Pixels...");
        // Command: 7E 00 09 00 C8 (200) 00 00 00 EF
        await send([0x7e, 0x00, 0x09, 0x00, 0xc8, 0x00, 0x00, 0x00, 0xef]);
        
        setTimeout(async () => {
            log("Setting GRB Sort...");
            await send([0x7e, 0x00, 0x08, 0x02, 0x00, 0x00, 0x00, 0x00, 0xef]);
        }, 250);

        setTimeout(async () => {
            log("Forcing Static Mode...");
            await send([0x7e, 0x00, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0xef]);
        }, 500);
    }

    function power(s) {
        send([0x7e, 0x00, 0x04, s, 0x00, 0x00, 0x00, 0x00, 0xef]);
        log("Power " + (s ? "ON" : "OFF"));
    }

    // Throttling for Mobile: Prevents crashing the chip when sliding finger
    function throttledColor(hex) {
        if (isSending) return;
        isSending = true;
        
        const r = parseInt(hex.substring(1, 3), 16);
        const g = parseInt(hex.substring(3, 5), 16);
        const b = parseInt(hex.substring(5, 7), 16);

        send([0x7e, 0x00, 0x05, 0x03, r, g, b, 0x00, 0xef]);

        setTimeout(() => { isSending = false; }, 60); 
    }
</script>

</body>
</html>
